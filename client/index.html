<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PetroRAG â€” Knowledge Intelligence</title>
  <meta name="description" content="PetroRAG multimodal RAG system client for document management and AI-powered chat.">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <!-- Sidebar toggle (mobile) -->
  <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fa-solid fa-bars"></i>
  </button>
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <i class="fa-solid fa-layer-group"></i> PetroRAG
      </div>
      <!-- User Profile -->
      <div class="user-profile" id="user-profile" onclick="openProfileModal()" title="Edit Profile">
        <div class="user-info">
          <div class="avatar"><i class="fa-solid fa-user-astronaut"></i></div>
          <span id="display-username">petro_user_01</span>
          <i class="fa-solid fa-gear settings-icon"></i>
        </div>
      </div>
    </div>

    <div class="sidebar-body">
      <div class="nav-section">
        <div class="nav-title">Categories</div>
        <div id="category-list">
          <!-- Categories injected here -->
        </div>
        <button class="add-btn" onclick="openModal('create-category-modal')">
          <i class="fa-solid fa-plus"></i> New Category
        </button>
      </div>

      <div class="nav-section">
        <div class="nav-title">Chats</div>
        <div id="chat-list">
          <!-- Chats injected here -->
        </div>
        <button class="add-btn" onclick="startNewChat()">
          <i class="fa-solid fa-plus"></i> New Chat
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-title">
        <h2 id="page-title">Dashboard</h2>
        <div id="page-subtitle" class="text-muted">Select a category or chat to begin</div>
      </div>
      <div class="header-actions" id="header-actions">
        <!-- Dynamic actions -->
      </div>
    </header>

    <!-- Views -->

    <!-- 1. Dashboard -->
    <div id="view-dashboard" class="view active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat-categories">0</div>
          <div class="stat-label">Categories</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-documents">0</div>
          <div class="stat-label">Documents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-chats">0</div>
          <div class="stat-label">Chat Sessions</div>
        </div>
      </div>
    </div>

    <!-- 2. Category View -->
    <div id="view-category" class="view">
      <div class="upload-section">
        <div class="upload-area" id="drop-zone">
          <div class="upload-icon">
            <i class="fa-solid fa-cloud-arrow-up"></i>
          </div>
          <h3>Drop Files or Click to Upload</h3>
          <p>Supports PDF documents. Maximum 50 files per batch.</p>
          <input type="file" id="file-input" multiple hidden accept=".pdf">

          <div style="margin-top: 1rem;">
            <label style="cursor: pointer; font-size: 0.82rem; color: var(--text-muted);">
              <input type="checkbox" id="is-daily" style="margin-right: 0.35rem;"> Daily Upload (auto-delete after 24h)
            </label>
          </div>

          <!-- File preview list inserted here -->
          <ul class="file-preview-list hidden" id="file-preview-list"></ul>
        </div>

        <!-- Explicit Upload Button (Initially Hidden) -->
        <button id="upload-files-btn" class="btn btn-primary hidden"
          style="width: 100%; margin-top: 0.5rem; justify-content: center;">
          <i class="fa-solid fa-cloud-arrow-up"></i> Start Upload
        </button>

        <div class="progress-bar-container" id="upload-progress-container">
          <div class="progress-bar" id="upload-progress-bar"></div>
        </div>
        <div id="upload-status-text"
          style="text-align: center; margin-top: 0.5rem; font-size: 0.82rem; color: var(--text-muted);"></div>
      </div>

      <div>
        <!-- Batch Controls -->
        <div id="batch-controls" class="batch-controls hidden">
          <span><i class="fa-solid fa-spinner fa-spin"></i> Processing Batch...</span>
          <button class="btn btn-danger" onclick="terminateCurrentBatch()">Terminate</button>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="font-weight: 700;">Documents</h3>
          <div style="gap: 0.5rem; display: flex;">
            <button class="btn btn-secondary btn-icon" onclick="refreshDocuments()" title="Refresh">
              <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button class="btn btn-danger" onclick="cleanupDaily()">
              <i class="fa-solid fa-broom"></i> Cleanup Daily
            </button>
          </div>
        </div>

        <table class="documents-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Type</th>
              <th>Added</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="documents-list">
            <!-- Docs here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 3. Chat View -->
    <div id="view-chat" class="view chat-view">
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="message ai">
            <div class="markdown-content">
              <p>Hello! I'm <strong>PetroRAG</strong>. Ask me anything about your uploaded documents.</p>
            </div>
          </div>
        </div>

        <!-- Scroll to bottom button -->
        <button class="scroll-bottom-btn" id="scroll-bottom-btn" onclick="scrollChatToBottom()">
          <i class="fa-solid fa-chevron-down"></i>
        </button>

        <!-- Image Preview Area -->
        <div id="chat-image-preview" class="chat-image-preview" style="display: none;"></div>

        <div class="chat-input-area">
          <input type="file" id="chat-image-input" multiple accept="image/*" hidden>
          <button class="btn btn-secondary btn-icon" onclick="document.getElementById('chat-image-input').click()"
            title="Attach Images">
            <i class="fa-solid fa-paperclip"></i>
          </button>
          <textarea class="chat-input" id="chat-input"
            placeholder="Type your message... (Enter to send, Shift+Enter for new line)"></textarea>
          <button class="btn btn-primary btn-icon" id="chat-send-btn" onclick="sendMessage()">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modals -->
  <!-- Create Category Modal -->
  <div id="create-category-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>New Category</h3>
        <button class="btn btn-secondary btn-icon" onclick="closeModal('create-category-modal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="form-group">
        <label>Name</label>
        <input type="text" class="form-control" id="new-cat-name" placeholder="e.g. Finance Reports 2024">
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" class="form-control" id="new-cat-desc" placeholder="Optional description">
      </div>
      <button class="btn btn-primary" style="width: 100%" onclick="createCategory()">
        <i class="fa-solid fa-plus"></i> Create Category
      </button>
    </div>
  </div>

  <!-- Rename Category Modal -->
  <div id="rename-category-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Rename Category</h3>
        <button class="btn btn-secondary btn-icon" onclick="closeModal('rename-category-modal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <input type="hidden" id="rename-cat-id">
      <div class="form-group">
        <label>New Name</label>
        <input type="text" class="form-control" id="rename-cat-name">
      </div>
      <div class="form-group">
        <label>New Description</label>
        <input type="text" class="form-control" id="rename-cat-desc">
      </div>
      <button class="btn btn-primary" style="width: 100%" onclick="submitRenameCategory()">
        <i class="fa-solid fa-check"></i> Save Changes
      </button>
    </div>
  </div>

  <!-- New Chat Configuration Modal -->
  <div id="new-chat-modal" class="modal">
    <div class="modal-content" style="width: 500px;">
      <div class="modal-header">
        <h3>Start New Chat</h3>
        <button class="btn btn-secondary btn-icon" onclick="closeModal('new-chat-modal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Select Knowledge Context</label>
        <div style="font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.75rem;">
          Choose which categories this chat should search across.
        </div>

        <div id="chat-category-selection"
          style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 0.5rem;">
          <!-- Categories checkboxes injected here -->
        </div>

        <div style="margin-top: 0.5rem; text-align: right;">
          <a href="#" onclick="toggleSelectAllCategories(true); return false;"
            style="font-size: 0.78rem; color: var(--primary-color); text-decoration: none;">Select All</a>
          <span style="color: var(--text-muted); margin: 0 0.25rem;">|</span>
          <a href="#" onclick="toggleSelectAllCategories(false); return false;"
            style="font-size: 0.78rem; color: var(--text-muted); text-decoration: none;">None</a>
        </div>
      </div>

      <button class="btn btn-primary" style="width: 100%" onclick="confirmStartChat()">
        <i class="fa-solid fa-comments"></i> Start Conversation
      </button>
    </div>
  </div>

  <!-- Welcome / Login Modal -->
  <div id="welcome-modal" class="modal">
    <div class="modal-content" style="text-align: center; max-width: 400px; animation: modalFadeIn 0.5s ease-out;">
      <div style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;">
        <i class="fa-solid fa-layer-group"></i>
      </div>
      <h2 style="margin-bottom: 0.5rem; font-weight: 800;">Welcome to PetroRAG</h2>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
        Please enter a username to continue. This will be used to identify your chat sessions and preferences.
      </p>
      <div class="form-group" style="text-align: left;">
        <input type="text" class="form-control" id="welcome-username-input" placeholder="e.g. John Doe"
          style="font-size: 1.1rem; padding: 0.75rem;">
      </div>
      <button class="btn btn-primary" style="width: 100%; justify-content: center; font-size: 1rem; padding: 0.75rem;"
        onclick="saveWelcomeUsername()">
        Get Started <i class="fa-solid fa-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="edit-profile-modal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Edit Profile</h3>
        <button class="btn btn-secondary btn-icon" onclick="closeModal('edit-profile-modal')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
        <div
          style="width: 80px; height: 80px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white;">
          <i class="fa-solid fa-user-astronaut"></i>
        </div>
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" class="form-control" id="profile-username-input" placeholder="Enter new username">
      </div>
      <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="saveProfileUsername()">
        <i class="fa-solid fa-check"></i> Save Changes
      </button>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
</body>

</html>